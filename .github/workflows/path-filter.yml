# Shared path filter configuration
# This reusable workflow checks if app-related files have changed.
# Used by Cerberus and Hades to avoid redundant builds.
#
# Filters are split (src, tests, config) to avoid dorny/paths-filter
# negation pattern bug. See: https://github.com/dorny/paths-filter/issues/97

name: Path Filter

on:
  workflow_call:
    outputs:
      app-changed:
        description: 'Whether app-related files have changed in the entire PR'
        value: ${{ jobs.check-paths.outputs.app-changed }}
      app-changed-this-push:
        description: 'Whether app-related files have changed in the latest push only (excluding test-only changes)'
        value: ${{ jobs.check-paths.outputs.app-changed-this-push }}
      shell-only:
        description: 'Whether only shell scripts have changed'
        value: ${{ jobs.check-paths.outputs.shell-only }}

jobs:
  check-paths:
    runs-on: ubuntu-latest
    outputs:
      # app-changed: src OR config changed (tests run for any code change)
      app-changed: ${{ steps.filter.outputs.src == 'true' || steps.filter.outputs.config == 'true' }}
      # app-changed-this-push: (src OR config) changed AND NOT (only tests changed)
      # This prevents build from running when only test files are pushed
      app-changed-this-push: ${{ (steps.filter-push.outputs.src == 'true' || steps.filter-push.outputs.config == 'true') && !(steps.filter-push.outputs.tests == 'true' && steps.filter-push.outputs.src != 'true' && steps.filter-push.outputs.config != 'true') }}
      shell-only: ${{ steps.filter.outputs.shell == 'true' && steps.filter.outputs.src != 'true' && steps.filter.outputs.config != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for app changes (entire PR)
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: .github/path-filters.yml

      # Check only the latest push (for build optimization)
      # On synchronize: compares against previous HEAD
      # On opened: compares against base branch (same as full PR check)
      - name: Check for app changes (this push only)
        uses: dorny/paths-filter@v3
        id: filter-push
        with:
          base: ${{ github.event.before }}
          filters: .github/path-filters.yml
