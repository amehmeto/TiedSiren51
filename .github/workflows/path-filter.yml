# Shared path filter configuration
# This reusable workflow checks if app-related files have changed.
# Used by Cerberus and Hades to avoid redundant builds.

name: Path Filter

on:
  workflow_call:
    outputs:
      app-changed:
        description: 'Whether app-related files have changed in the entire PR'
        value: ${{ jobs.check-paths.outputs.app-changed }}
      app-changed-this-push:
        description: 'Whether app-related files have changed in the latest push only'
        value: ${{ jobs.check-paths.outputs.app-changed-this-push }}
      shell-only:
        description: 'Whether only shell scripts have changed'
        value: ${{ jobs.check-paths.outputs.shell-only }}

jobs:
  check-paths:
    runs-on: ubuntu-latest
    outputs:
      app-changed: ${{ steps.filter.outputs.app }}
      app-changed-this-push: ${{ steps.filter-push.outputs.app }}
      shell-only: ${{ steps.filter.outputs.shell == 'true' && steps.filter.outputs.app != 'true' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for app changes (entire PR)
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            shell:
              - '**/*.sh'
              - '.husky/**'
              - '.claude/hooks/**'
            app:
              # Source code
              - 'app/**'
              - 'core/**'
              - 'ui/**'
              - 'infra/**'
              - 'pdb-block-sessions/**'
              - 'pdb-blocklists/**'
              - 'pdb-remote-devices/**'
              - 'pdb-sirens/**'
              # Config files that affect the build
              - 'app.config.js'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'babel.config.cjs'
              - 'metro.config.cjs'
              - 'eas.json'
              - 'schema.prisma'
              - 'index.js'
              # Platform specific
              - 'android/**'
              - 'ios/**'
              # Assets
              - 'assets/**'
              # Environment files
              - '.env*'

      # Check only the latest push (for build optimization)
      # On synchronize: compares against previous HEAD
      # On opened: compares against base branch (same as full PR check)
      # NOTE: Keep app filter paths in sync with the filter above
      - name: Check for app changes (this push only)
        uses: dorny/paths-filter@v3
        id: filter-push
        with:
          base: ${{ github.event.before }}
          filters: |
            app:
              # Source code
              - 'app/**'
              - 'core/**'
              - 'ui/**'
              - 'infra/**'
              - 'pdb-block-sessions/**'
              - 'pdb-blocklists/**'
              - 'pdb-remote-devices/**'
              - 'pdb-sirens/**'
              # Config files that affect the build
              - 'app.config.js'
              - 'package.json'
              - 'package-lock.json'
              - 'tsconfig.json'
              - 'babel.config.cjs'
              - 'metro.config.cjs'
              - 'eas.json'
              - 'schema.prisma'
              - 'index.js'
              # Platform specific
              - 'android/**'
              - 'ios/**'
              # Assets
              - 'assets/**'
              # Environment files
              - '.env*'
