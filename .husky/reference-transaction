#!/bin/sh
# Post-push CI watch trigger via reference-transaction hook
# Git doesn't have a native post-push hook, so we detect successful pushes
# by watching for tracking ref updates (refs/remotes/origin/...)
#
# This hook is called with: prepared, committed, or aborted
# We only act on "committed" to run CI watch after successful push

# CI_WATCH_REMOTE: configurable remote name (default: origin)
remote="${CI_WATCH_REMOTE:-origin}"

# Only process "committed" phase (refs successfully updated)
if [ "$1" != "committed" ]; then
  exit 0
fi

# Read ref updates from stdin, looking for tracking ref updates
ci_exit_code=0
while IFS= read -r line || [ -n "$line" ]; do
  # Parse: oldvalue newvalue refname (oldvalue unused)
  rest="${line#* }"
  newvalue="${rest%% *}"
  refname="${rest#* }"

  # Match refs/remotes/<remote>/<branch>
  case "$refname" in
    refs/remotes/"$remote"/*)
      # Extract branch name (quote $remote separately per SC2295)
      pushed_branch="${refname#refs/remotes/"$remote"/}"
      # Run CI watch (blocks until complete, Ctrl+C to cancel)
      PUSHED_BRANCH="$pushed_branch" PUSHED_SHA="$newvalue" sh .husky/post-push
      ci_exit_code=$?
      break
      ;;
  esac
done

exit $ci_exit_code
