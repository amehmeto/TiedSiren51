#!/bin/sh
# Detect pushed branch from the ref being updated, not from current HEAD
# This correctly handles: git push origin feature-x (while on main)
# CI_WATCH_REMOTE: configurable remote name (default: origin)
remote="${CI_WATCH_REMOTE:-origin}"
while read -r oldvalue newvalue refname; do
  if [ "$1" = "committed" ] && echo "$refname" | grep -q "^refs/remotes/$remote/"; then
    # Extract branch name from refs/remotes/<remote>/<branch>
    pushed_branch="${refname#refs/remotes/$remote/}"
    # Run synchronously - blocks until CI completes (Ctrl+C to cancel)
    PUSHED_BRANCH="$pushed_branch" PUSHED_SHA="$newvalue" sh .husky/post-push
    break
  fi
done
# Ensure clean exit (while read returns non-zero on EOF which triggers sh -e)
exit 0
